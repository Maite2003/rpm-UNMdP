
generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// --------------------------------------------------------
// ENUMS
// --------------------------------------------------------

enum StudentStatus {
  PENDING
  VERIFIED
  REJECTED
  NOT_STUDENT
}

enum DocType {
  DNI
  PASSPORT
}

enum Semester {
  FIRST
  SECOND
  ANNUAL
}

enum CommissionRole {
  GRADUATE_ASSISTANT
  STUDENT_ASSISTANT
  THEORY_PROFESSOR
  PRACTICE_PROFESSOR
}

enum ReviewStatus {
  PUBLISHED
  PENDING
  BANNED
}

enum ReviewType {
  COMMISSION
  PROFESSOR
}

// --------------------------------------------------------
// ACADEMIC STRUCTURE
// --------------------------------------------------------

model Faculty {
  id            String      @id @default(uuid())
  name          String
  abbreviation  String?

  universityId  String
  university    University @relation(fields: [universityId], references: [id], onDelete: Cascade)

  careers Career[]
}

model University {
  id            String      @id @default(uuid())
  name          String
  abbreviation  String?
  website       String?
  faculties Faculty[]
}

model Career {
  id           String      @id @default(uuid())
  name         String
  facultyId    String

  faculty     Faculty     @relation(fields: [facultyId], references: [id], onDelete: Cascade)
  studyPlans  StudyPlan[]
  enrollments Enrollment[]
}

model StudyPlan {
  id           String      @id @default(uuid())
  careerId     String
  subjectCount Int
  totalYears  Int
  isActive     Boolean            @default(true)
  year         Int

  career    Career             @relation(fields: [careerId], references: [id], onDelete: Cascade)
  subjects  StudyPlanSubject[]
}

model Subject {
  id           String      @id @default(uuid())
  name         String
  code         String
  credits      Int
  hours        Int

  // Relations
  plans        StudyPlanSubject[]
  commissions  Commission[]

  // Self-relation for Correlatives (Many-to-Many)
  predecessors Correlation[]      @relation("SubjectSuccessor")
  successors   Correlation[]      @relation("SubjectPredecessor")
}

model StudyPlanSubject {
  planId          String
  subjectId       String
  year            Int       // Academic year (1st, 2nd, etc.)
  semester        Semester
  offCycleOption  Boolean  @default(false)

  plan      StudyPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  subject   Subject   @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@id([planId, subjectId])
}

model Correlation {
  predecessorId String
  successorId   String

  predecessor   Subject @relation("SubjectPredecessor", fields: [predecessorId], references: [id], onDelete: Cascade)
  successor     Subject @relation("SubjectSuccessor", fields: [successorId], references: [id], onDelete: Cascade)

  @@id([predecessorId, successorId])
}

// --------------------------------------------------------
// OFFERINGS & STAFF
// --------------------------------------------------------

model Commission {
  id           String      @id @default(uuid())
  year         Int
  schedules    String?
  semester     Semester
  subjectId    String

  isDeleted     Boolean   @default(false)

  subject      Subject               @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  professors   CommissionProfessor[]
  reviews      Review[]
}

model Professor {
  id          String      @id @default(uuid())
  full_name   String                // Full Name
  
  commissions CommissionProfessor[]
  reviews     ReviewProfessorDetail[]
}

model CommissionProfessor {
  commissionId String
  professorId  String
  role         CommissionRole

  commission   Commission @relation(fields: [commissionId], references: [id], onDelete: Cascade)
  professor    Professor  @relation(fields: [professorId], references: [id], onDelete: Cascade)

  @@id([commissionId, professorId])
}

// --------------------------------------------------------
// USERS
// --------------------------------------------------------

model User {
  id            String      @id @default(uuid())
  
  docType       DocType
  docNumber     String
  firstName     String
  lastName      String
  password      String
  email         String         @unique

  isAdmin       Boolean        @default(false)
  studentStatus StudentStatus? 

  isDeleted     Boolean        @default(false)

  enrollments   Enrollment[]
  reviews       Review[]
  votes         Vote[]

  reportedReviews Review[]      @relation("ReportedReviews")
  auditLogs       ReviewAudit[] @relation("AuditReporter")

  @@unique([docType, docNumber])
}

model Enrollment {
  studentId  String
  careerId   String
  date       DateTime @default(now())
  fileNumber String  // Legajo

  student   User @relation(fields: [studentId], references: [id], onDelete: Cascade)
  career    Career  @relation(fields: [careerId], references: [id], onDelete: Cascade)

  @@id([studentId, careerId])
}

// --------------------------------------------------------
// REVIEWS & VOTING SYSTEM
// --------------------------------------------------------

model Review {
  id           String      @id @default(uuid())
  commissionId String
  studentId    String
  dislikeCount Int          @default(0)
  likeCount    Int          @default(0)
  date         DateTime     @default(now())
  status       ReviewStatus @default(PUBLISHED)
  content      String       @db.Text
  type         ReviewType

  isAnonymous  Boolean      @default(false)

  reporterId   String?
  reporter     User?     @relation("ReportedReviews", fields: [reporterId], references: [id], onDelete: SetNull)

  commission   Commission   @relation(fields: [commissionId], references: [id], onDelete: Cascade)
  student      User      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  // One-to-One Optional Relations (Hierarchy Implementation)
  // Deleting the parent Review will cascade delete the detail
  professorDetail  ReviewProfessorDetail?
  commissionDetail ReviewCommissionDetail?

  votes            Vote[]
  audits           ReviewAudit[]
}

model ReviewProfessorDetail {
  reviewId           String @id // PK is also FK to Parent
  professorId        String
  
  // Scores (1-5)
  treatmentScore     Int
  explanationScore   Int

  review    Review    @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  professor Professor @relation(fields: [professorId], references: [id], onDelete: Cascade)
}

model ReviewCommissionDetail {
  reviewId       String @id // PK is also FK to Parent
  
  // Scores (1-5)
  contentScore   Int
  difficultyScore Int

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
}

model Vote {
  studentId  String
  reviewId   String
  isPositive Boolean
  date       DateTime @default(now())

  student    User @relation(fields: [studentId], references: [id], onDelete: Cascade)
  review     Review  @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@id([studentId, reviewId]) // One vote per student per review
}

model ReviewAudit {
  id              String      @id @default(uuid())
  reviewId        String
  date            DateTime @default(now())
  reason          String?
  originalContent String?  @db.Text

  reporterId      String?
  reporter        User? @relation("AuditReporter", fields: [reporterId], references: [id], onDelete: SetNull)

  review          Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
}